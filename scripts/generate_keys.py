#!/usr/bin/env python3
# generate_keys.py - ç”Ÿæˆ BLS å¯†é’¥å¯¹
import sys
import os
sys.path.append('../services/ai')
from py_ecc.bls import G2ProofOfPossession as bls
import secrets

def generate_validator_keys(index):
    """ç”Ÿæˆå•ä¸ªéªŒè¯è€…çš„BLSå¯†é’¥å¯¹"""
    # BLS12-381 æ›²çº¿çš„é˜¶æ•°
    CURVE_ORDER = 52435875175126190479447740508185965837690552500527637822603658699938581184513
    
    # ç”Ÿæˆç§é’¥
    sk = secrets.randbelow(CURVE_ORDER)
    
    # ä»ç§é’¥æ´¾ç”Ÿå…¬é’¥
    pk = bls.SkToPk(sk)
    
    return sk, pk

def write_to_env(keys, env_path='.env'):
    """å°†å¯†é’¥å†™å…¥ .env æ–‡ä»¶"""
    # è¯»å–ç°æœ‰çš„ .env æ–‡ä»¶å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    existing_lines = []
    if os.path.exists(env_path):
        with open(env_path, 'r') as f:
            existing_lines = f.readlines()
    
    # è¿‡æ»¤æ‰æ—§çš„ VALIDATOR_*_SK è¡Œ
    filtered_lines = [line for line in existing_lines 
                      if not line.startswith('VALIDATOR_') or '_SK=' not in line]
    
    # æ·»åŠ æ–°çš„å¯†é’¥
    new_lines = filtered_lines.copy()
    if new_lines and not new_lines[-1].endswith('\n'):
        new_lines.append('\n')
    
    new_lines.append('\n# Validator Keys (Generated by generate_keys.py)\n')
    for i, (sk, pk) in enumerate(keys, 1):
        new_lines.append(f'VALIDATOR_{i}_SK={sk}\n')
    
    # å†™å…¥æ–‡ä»¶
    with open(env_path, 'w') as f:
        f.writelines(new_lines)
    
    print(f"âœ… Keys successfully written to {env_path}")

if __name__ == "__main__":
    print("="*60)
    print(" BLS Key Generation for EchoRank DVT Validators")
    print("="*60)
    print()
    
    # ä¸º 3 ä¸ªéªŒè¯èŠ‚ç‚¹ç”Ÿæˆå¯†é’¥
    keys = []
    for i in range(1, 4):
        sk, pk = generate_validator_keys(i)
        keys.append((sk, pk))
        print(f"âœ“ Generated keys for Validator {i}")
    
    print()
    print("="*60)
    print(" Writing keys to .env file...")
    print("="*60)
    print()
    
    # ç¡®å®š .env æ–‡ä»¶è·¯å¾„ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
    script_dir = os.path.dirname(os.path.abspath(__file__))
    project_root = os.path.dirname(script_dir)
    env_path = os.path.join(project_root, '.env')
    
    # å†™å…¥ .env æ–‡ä»¶
    write_to_env(keys, env_path)
    
    print()
    print("="*60)
    print(" âš ï¸  IMPORTANT: Backup these keys securely!")
    print("="*60)
    print()
    print("Generated keys:")
    for i, (sk, pk) in enumerate(keys, 1):
        print(f"VALIDATOR_{i}_SK={sk}")
    print()
    print(f"ğŸ“ Keys saved to: {env_path}")